"use strict";
/* Copyright: Ankitects Pty Ltd and contributors
 * License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var ankiPlatform = "desktop";
var typeans;
var _updatingQueue = Promise.resolve();
var onUpdateHook;
var onShownHook;
function _runHook(arr) {
    const promises = [];
    for (let i = 0; i < arr.length; i++) {
        promises.push(arr[i]());
    }
    return Promise.all(promises);
}
function _queueAction(action) {
    _updatingQueue = _updatingQueue.then(action);
}
function setInnerHTML(element, html) {
    for (const oldVideo of element.getElementsByTagName("video")) {
        oldVideo.pause();
        while (oldVideo.firstChild) {
            oldVideo.removeChild(oldVideo.firstChild);
        }
        oldVideo.load();
    }
    element.innerHTML = html;
    for (const oldScript of element.getElementsByTagName("script")) {
        const newScript = document.createElement("script");
        for (const attribute of oldScript.attributes) {
            newScript.setAttribute(attribute.name, attribute.value);
        }
        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.parentNode.replaceChild(newScript, oldScript);
    }
}
function _updateQA(html, _unusused, onupdate, onshown) {
    return __awaiter(this, void 0, void 0, function* () {
        onUpdateHook = [onupdate];
        onShownHook = [onshown];
        const qa = document.getElementById("qa");
        const renderError = (kind) => (error) => {
            const errorMessage = String(error).substring(0, 2000);
            const errorStack = String(error.stack).substring(0, 2000);
            qa.innerHTML = `Invalid ${kind} on card: ${errorMessage}\n${errorStack}`.replace(/\n/g, "<br>");
        };
        // hide current card
        qa.style.opacity = "0";
        // update card
        try {
            setInnerHTML(qa, html);
        }
        catch (error) {
            renderError("HTML")(error);
        }
        yield _runHook(onUpdateHook);
        // wait for mathjax to ready
        yield MathJax.startup.promise
            .then(() => {
            // clear MathJax buffers from previous typesets
            MathJax.typesetClear();
            return MathJax.typesetPromise([qa]);
        })
            .catch(renderError("MathJax"));
        // defer display for up to 100ms to allow images to load
        yield Promise.race([allImagesLoaded(), new Promise((r) => setTimeout(r, 100))]);
        // and reveal card when processing is done
        qa.style.opacity = "1";
        yield _runHook(onShownHook);
    });
}
function _showQuestion(q, bodyclass) {
    _queueAction(() => _updateQA(q, null, function () {
        // return to top of window
        window.scrollTo(0, 0);
        document.body.className = bodyclass;
    }, function () {
        // focus typing area if visible
        typeans = document.getElementById("typeans");
        if (typeans) {
            typeans.focus();
        }
    }));
}
function _showAnswer(a, bodyclass) {
    _queueAction(() => _updateQA(a, null, function () {
        if (bodyclass) {
            //  when previewing
            document.body.className = bodyclass;
        }
        // avoid scrolling to the answer until images load, even if it
        // takes more than 100ms
        allImagesLoaded().then(scrollToAnswer);
    }, function () { }));
}
const _flagColours = {
    1: "#ff6666",
    2: "#ff9900",
    3: "#77ff77",
    4: "#77aaff",
};
function _drawFlag(flag) {
    const elem = document.getElementById("_flag");
    if (flag === 0) {
        elem.setAttribute("hidden", "");
        return;
    }
    elem.removeAttribute("hidden");
    elem.style.color = _flagColours[flag];
}
function _drawMark(mark) {
    const elem = document.getElementById("_mark");
    if (!mark) {
        elem.setAttribute("hidden", "");
    }
    else {
        elem.removeAttribute("hidden");
    }
}
function _typeAnsPress() {
    if (window.event.code === "Enter") {
        pycmd("ans");
    }
}
function _emulateMobile(enabled) {
    const list = document.documentElement.classList;
    if (enabled) {
        list.add("mobile");
    }
    else {
        list.remove("mobile");
    }
}
function allImagesLoaded() {
    return Promise.all(Array.from(document.getElementsByTagName("img")).map(imageLoaded));
}
function imageLoaded(img) {
    return img.complete
        ? Promise.resolve()
        : new Promise((resolve) => {
            img.addEventListener("load", () => resolve());
            img.addEventListener("error", () => resolve());
        });
}
function scrollToAnswer() {
    var _a;
    (_a = document.getElementById("answer")) === null || _a === void 0 ? void 0 : _a.scrollIntoView();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV2aWV3ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9xdC9hcXQvZGF0YS93ZWIvanMvcmV2aWV3ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO2tGQUNrRjs7Ozs7Ozs7OztBQU1sRixJQUFJLFlBQVksR0FBRyxTQUFTLENBQUM7QUFDN0IsSUFBSSxPQUFnQyxDQUFDO0FBQ3JDLElBQUksY0FBYyxHQUFrQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7QUFFdEQsSUFBSSxZQUE2QixDQUFDO0FBQ2xDLElBQUksV0FBNEIsQ0FBQztBQUVqQyxTQUFTLFFBQVEsQ0FBQyxHQUFvQjtJQUNsQyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7SUFFcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDakMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQzNCO0lBRUQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxNQUFnQjtJQUNsQyxjQUFjLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsT0FBZ0IsRUFBRSxJQUFZO0lBQ2hELEtBQUssTUFBTSxRQUFRLElBQUksT0FBTyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzFELFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVqQixPQUFPLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDeEIsUUFBUSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDN0M7UUFFRCxRQUFRLENBQUMsSUFBSSxFQUFF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T0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDcEIsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQzlDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUNuRCxDQUFDLENBQUMsQ0FBQztBQUNiLENBQUM7QUFFRCxTQUFTLGNBQWM7O0lBQ25CLE1BQUEsUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsMENBQUUsY0FBYyxFQUFFLENBQUM7QUFDeEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIENvcHlyaWdodDogQW5raXRlY3RzIFB0eSBMdGQgYW5kIGNvbnRyaWJ1dG9yc1xuICogTGljZW5zZTogR05VIEFHUEwsIHZlcnNpb24gMyBvciBsYXRlcjsgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2FncGwuaHRtbCAqL1xuXG5kZWNsYXJlIHZhciBNYXRoSmF4OiBhbnk7XG5cbnR5cGUgQ2FsbGJhY2sgPSAoKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcblxudmFyIGFua2lQbGF0Zm9ybSA9IFwiZGVza3RvcFwiO1xudmFyIHR5cGVhbnM6IEhUTUxFbGVtZW50IHwgdW5kZWZpbmVkO1xudmFyIF91cGRhdGluZ1F1ZXVlOiBQcm9taXNlPHZvaWQ+ID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbnZhciBvblVwZGF0ZUhvb2s6IEFycmF5PENhbGxiYWNrPjtcbnZhciBvblNob3duSG9vazogQXJyYXk8Q2FsbGJhY2s+O1xuXG5mdW5jdGlvbiBfcnVuSG9vayhhcnI6IEFycmF5PENhbGxiYWNrPik6IFByb21pc2U8dm9pZFtdPiB7XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2goYXJyW2ldKCkpO1xuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG59XG5cbmZ1bmN0aW9uIF9xdWV1ZUFjdGlvbihhY3Rpb246IENhbGxiYWNrKTogdm9pZCB7XG4gICAgX3VwZGF0aW5nUXVldWUgPSBfdXBkYXRpbmdRdWV1ZS50aGVuKGFjdGlvbik7XG59XG5cbmZ1bmN0aW9uIHNldElubmVySFRNTChlbGVtZW50OiBFbGVtZW50LCBodG1sOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IG9sZFZpZGVvIG9mIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJ2aWRlb1wiKSkge1xuICAgICAgICBvbGRWaWRlby5wYXVzZSgpO1xuXG4gICAgICAgIHdoaWxlIChvbGRWaWRlby5maXJzdENoaWxkKSB7XG4gICAgICAgICAgICBvbGRWaWRlby5yZW1vdmVDaGlsZChvbGRWaWRlby5maXJzdENoaWxkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG9sZFZpZGVvLmxvYWQoKTtcbiAgICB9XG5cbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWw7XG5cbiAgICBmb3IgKGNvbnN0IG9sZFNjcmlwdCBvZiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwic2NyaXB0XCIpKSB7XG4gICAgICAgIGNvbnN0IG5ld1NjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzY3JpcHRcIik7XG5cbiAgICAgICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgb2Ygb2xkU2NyaXB0LmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgIG5ld1NjcmlwdC5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlLm5hbWUsIGF0dHJpYnV0ZS52YWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdTY3JpcHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUob2xkU2NyaXB0LmlubmVySFRNTCkpO1xuICAgICAgICBvbGRTY3JpcHQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3U2NyaXB0LCBvbGRTY3JpcHQpO1xuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX3VwZGF0ZVFBKFxuICAgIGh0bWw6IHN0cmluZyxcbiAgICBfdW51c3VzZWQ6IHVua25vd24sXG4gICAgb251cGRhdGU6IENhbGxiYWNrLFxuICAgIG9uc2hvd246IENhbGxiYWNrXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBvblVwZGF0ZUhvb2sgPSBbb251cGRhdGVdO1xuICAgIG9uU2hvd25Ib29rID0gW29uc2hvd25dO1xuXG4gICAgY29uc3QgcWEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInFhXCIpITtcbiAgICBjb25zdCByZW5kZXJFcnJvciA9IChraW5kOiBzdHJpbmcpID0+IChlcnJvcjogRXJyb3IpOiB2b2lkID0+IHtcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gU3RyaW5nKGVycm9yKS5zdWJzdHJpbmcoMCwgMjAwMCk7XG4gICAgICAgIGNvbnN0IGVycm9yU3RhY2sgPSBTdHJpbmcoZXJyb3Iuc3RhY2spLnN1YnN0cmluZygwLCAyMDAwKTtcbiAgICAgICAgcWEuaW5uZXJIVE1MID0gYEludmFsaWQgJHtraW5kfSBvbiBjYXJkOiAke2Vycm9yTWVzc2FnZX1cXG4ke2Vycm9yU3RhY2t9YC5yZXBsYWNlKFxuICAgICAgICAgICAgL1xcbi9nLFxuICAgICAgICAgICAgXCI8YnI+XCJcbiAgICAgICAgKTtcbiAgICB9O1xuXG4gICAgLy8gaGlkZSBjdXJyZW50IGNhcmRcbiAgICBxYS5zdHlsZS5vcGFjaXR5ID0gXCIwXCI7XG5cbiAgICAvLyB1cGRhdGUgY2FyZFxuICAgIHRyeSB7XG4gICAgICAgIHNldElubmVySFRNTChxYSwgaHRtbCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmVuZGVyRXJyb3IoXCJIVE1MXCIpKGVycm9yKTtcbiAgICB9XG5cbiAgICBhd2FpdCBfcnVuSG9vayhvblVwZGF0ZUhvb2spO1xuXG4gICAgLy8gd2FpdCBmb3IgbWF0aGpheCB0byByZWFkeVxuICAgIGF3YWl0IE1hdGhKYXguc3RhcnR1cC5wcm9taXNlXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIC8vIGNsZWFyIE1hdGhKYXggYnVmZmVycyBmcm9tIHByZXZpb3VzIHR5cGVzZXRzXG4gICAgICAgICAgICBNYXRoSmF4LnR5cGVzZXRDbGVhcigpO1xuXG4gICAgICAgICAgICByZXR1cm4gTWF0aEpheC50eXBlc2V0UHJvbWlzZShbcWFdKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlbmRlckVycm9yKFwiTWF0aEpheFwiKSk7XG5cbiAgICAvLyBkZWZlciBkaXNwbGF5IGZvciB1cCB0byAxMDBtcyB0byBhbGxvdyBpbWFnZXMgdG8gbG9hZFxuICAgIGF3YWl0IFByb21pc2UucmFjZShbYWxsSW1hZ2VzTG9hZGVkKCksIG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDEwMCkpXSk7XG5cbiAgICAvLyBhbmQgcmV2ZWFsIGNhcmQgd2hlbiBwcm9jZXNzaW5nIGlzIGRvbmVcbiAgICBxYS5zdHlsZS5vcGFjaXR5ID0gXCIxXCI7XG4gICAgYXdhaXQgX3J1bkhvb2sob25TaG93bkhvb2spO1xufVxuXG5mdW5jdGlvbiBfc2hvd1F1ZXN0aW9uKHE6IHN0cmluZywgYm9keWNsYXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBfcXVldWVBY3Rpb24oKCkgPT5cbiAgICAgICAgX3VwZGF0ZVFBKFxuICAgICAgICAgICAgcSxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRvIHRvcCBvZiB3aW5kb3dcbiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7XG5cbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTmFtZSA9IGJvZHljbGFzcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gZm9jdXMgdHlwaW5nIGFyZWEgaWYgdmlzaWJsZVxuICAgICAgICAgICAgICAgIHR5cGVhbnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInR5cGVhbnNcIik7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVhbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZWFucy5mb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICk7XG59XG5cbmZ1bmN0aW9uIF9zaG93QW5zd2VyKGE6IHN0cmluZywgYm9keWNsYXNzOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBfcXVldWVBY3Rpb24oKCkgPT5cbiAgICAgICAgX3VwZGF0ZVFBKFxuICAgICAgICAgICAgYSxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJvZHljbGFzcykge1xuICAgICAgICAgICAgICAgICAgICAvLyAgd2hlbiBwcmV2aWV3aW5nXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NOYW1lID0gYm9keWNsYXNzO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGF2b2lkIHNjcm9sbGluZyB0byB0aGUgYW5zd2VyIHVudGlsIGltYWdlcyBsb2FkLCBldmVuIGlmIGl0XG4gICAgICAgICAgICAgICAgLy8gdGFrZXMgbW9yZSB0aGFuIDEwMG1zXG4gICAgICAgICAgICAgICAgYWxsSW1hZ2VzTG9hZGVkKCkudGhlbihzY3JvbGxUb0Fuc3dlcik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKCkge31cbiAgICAgICAgKVxuICAgICk7XG59XG5cbmNvbnN0IF9mbGFnQ29sb3VycyA9IHtcbiAgICAxOiBcIiNmZjY2NjZcIixcbiAgICAyOiBcIiNmZjk5MDBcIixcbiAgICAzOiBcIiM3N2ZmNzdcIixcbiAgICA0OiBcIiM3N2FhZmZcIixcbn07XG5cbmZ1bmN0aW9uIF9kcmF3RmxhZyhmbGFnOiAwIHwgMSB8IDIgfCAzIHwgNCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIl9mbGFnXCIpO1xuICAgIGlmIChmbGFnID09PSAwKSB7XG4gICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKFwiaGlkZGVuXCIsIFwiXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKFwiaGlkZGVuXCIpO1xuICAgIGVsZW0uc3R5bGUuY29sb3IgPSBfZmxhZ0NvbG91cnNbZmxhZ107XG59XG5cbmZ1bmN0aW9uIF9kcmF3TWFyayhtYXJrOiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3QgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiX21hcmtcIik7XG4gICAgaWYgKCFtYXJrKSB7XG4gICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKFwiaGlkZGVuXCIsIFwiXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKFwiaGlkZGVuXCIpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gX3R5cGVBbnNQcmVzcygpOiB2b2lkIHtcbiAgICBpZiAoKHdpbmRvdy5ldmVudCBhcyBLZXlib2FyZEV2ZW50KS5jb2RlID09PSBcIkVudGVyXCIpIHtcbiAgICAgICAgcHljbWQoXCJhbnNcIik7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBfZW11bGF0ZU1vYmlsZShlbmFibGVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3QgbGlzdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3Q7XG4gICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgICAgbGlzdC5hZGQoXCJtb2JpbGVcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbGlzdC5yZW1vdmUoXCJtb2JpbGVcIik7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhbGxJbWFnZXNMb2FkZWQoKTogUHJvbWlzZTx2b2lkW10+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICAgIEFycmF5LmZyb20oZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbWdcIikpLm1hcChpbWFnZUxvYWRlZClcbiAgICApO1xufVxuXG5mdW5jdGlvbiBpbWFnZUxvYWRlZChpbWc6IEhUTUxJbWFnZUVsZW1lbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gaW1nLmNvbXBsZXRlXG4gICAgICAgID8gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgOiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgICBpbWcuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgKCkgPT4gcmVzb2x2ZSgpKTtcbiAgICAgICAgICAgICAgaW1nLmFkZEV2ZW50TGlzdGVuZXIoXCJlcnJvclwiLCAoKSA9PiByZXNvbHZlKCkpO1xuICAgICAgICAgIH0pO1xufVxuXG5mdW5jdGlvbiBzY3JvbGxUb0Fuc3dlcigpOiB2b2lkIHtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFuc3dlclwiKT8uc2Nyb2xsSW50b1ZpZXcoKTtcbn1cbiJdfQ==