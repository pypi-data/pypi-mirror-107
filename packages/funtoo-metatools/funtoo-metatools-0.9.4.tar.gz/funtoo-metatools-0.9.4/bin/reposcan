#!/usr/bin/env python3

from dict_tools.data import NamespaceDict
from subpop.hub import Hub

hub = Hub()

import dyne.org.funtoo.metatools.merge as merge


async def main_thread(repo_plus_overlays):
	pos = 0
	for kit_dict in repo_plus_overlays:
		ctx = NamespaceDict()
		ctx["kit"] = NamespaceDict(kit_dict)
		out_tree = await merge.kit.checkout_kit(ctx)

		if pos == 0:
			merge.model.ECLASS_ROOT = out_tree.root
			merge.model.ECLASS_HASHES = merge.metadata.get_eclass_hashes(merge.model.ECLASS_ROOT)

		merge.metadata.fetch_kit(out_tree)
		merge.metadata.gen_cache(out_tree)
		merge.metadata.flush_kit(out_tree)
		pos += 1


if __name__ == "__main__":
	merge.metadata.cleanup_error_logs()
	repo_plus_overlays = [
		{
			"name": "gentoo",
			"url": "https://github.com/gentoo/gentoo.git",
			"branch": "master",  # Set to actual branch name
			"kind": "independent",
			"commit_sha1": None,  # You should be able to set commit SHA1 here.
		},
		{
			"name": "stefantalpalaru",
			"url": "https://github.com/stefantalpalaru/gentoo-overlay.git",
			"branch": "master",
			"kind": "independent",
			"commit_sha1": "072e7163a41bac59451059556fd0075c0c91e133",
		},
	]

	hub.LOOP.run_until_complete(main_thread(repo_plus_overlays))
